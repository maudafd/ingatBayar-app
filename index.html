<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bill Payment Reminder</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="header">
      <div class="container">
        <div class="row align-items-center">
          <div class="col">
            <h1 class="h3 mb-0 fw-bold">IngatBayar</h1>
          </div>
          <div class="col-auto">
            <div class="d-flex align-items-center gap-3">
              <button class="theme-toggle" id="themeToggle" title="Toggle Theme">
                <i class="fas fa-moon" id="themeIcon"></i>
              </button>
              <div class="input-group" style="width: 300px">
                <span class="input-group-text bg-white border-end-0">
                  <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" class="form-control border-start-0" placeholder="Cari Tagihan..." id="searchInput" />
              </div>
              <button class="btn create-btn text-white" data-bs-toggle="modal" data-bs-target="#billModal"><i class="fas fa-plus me-2"></i>Buat Tagihan</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- Dashboard Statistics -->
      <div class="dashboard-cards">
        <h2 class="dashboard-title"><i class="fas fa-chart-line me-2"></i>Dashboard Ringkasan</h2>
        <div class="row g-4">
          <div class="col-md-3 col-sm-6">
            <div class="stat-card total">
              <div class="stat-number" id="totalBills">0</div>
              <div class="stat-label">Total Tagihan</div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div class="stat-card paid">
              <div class="stat-number" id="paidBills">0</div>
              <div class="stat-label">Tagihan Dibayar</div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div class="stat-card unpaid">
              <div class="stat-number" id="unpaidBills">0</div>
              <div class="stat-label">Tagihan Belum Dibayar</div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div class="stat-card overdue">
              <div class="stat-number" id="overdueBills">0</div>
              <div class="stat-label">Tagihan Terlambat</div>
            </div>
          </div>
        </div>
        <div class="row g-4 mt-2">
          <div class="col-md-6">
            <div class="stat-card">
              <div class="stat-number text-success" id="totalPaid">Rp 0</div>
              <div class="stat-label">Total Tagihan Dibayar</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="stat-card">
              <div class="stat-number text-warning" id="totalPending">Rp 0</div>
              <div class="stat-label">Total Tagihan Tertunda</div>
            </div>
          </div>
        </div>
      </div>

      <div class="filter-tabs">
        <div class="d-flex flex-wrap justify-content-center">
          <button class="filter-btn all active" data-status="all">Semua</button>
          <button class="filter-btn paid" data-status="paid"><i class="fas fa-check-circle me-1"></i>Dibayar</button>
          <button class="filter-btn unpaid" data-status="unpaid"><i class="fas fa-clock me-1"></i>Belum Dibayar</button>
          <button class="filter-btn overdue" data-status="overdue"><i class="fas fa-exclamation-triangle me-1"></i>Terlambat</button>
          <button class="filter-btn draft" data-status="draft"><i class="fas fa-file me-1"></i>Draf</button>
        </div>
      </div>

      <div class="bills-container">
        <div id="emptyState" class="empty-state d-none">
          <i class="fas fa-file-invoice-dollar"></i>
          <h4>Tidak ada tagihan ditemukan</h4>
          <p class="mb-0">Buat tagihan pertama Anda untuk memulai!</p>
        </div>

        <table class="table bills-table" id="billsTable">
          <thead>
            <tr>
              <th>Nama Tagihan</th>
              <th>Tanggal Buat</th>
              <th>Jatuh Tempo</th>
              <th>Jumlah</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="billsTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Bill Modal -->
    <div class="modal fade" id="billModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Buat Tagihan Baru</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="billForm">
              <div class="mb-3">
                <label for="billTitle" class="form-label">Nama Tagihan *</label>
                <input type="text" class="form-control" id="billTitle" required />
                <div class="invalid-feedback">Silahkan, masukkan nama tagihan</div>
              </div>

              <div class="mb-3">
                <label for="billAmount" class="form-label">Jumlah (Rp) *</label>
                <input type="number" class="form-control" id="billAmount" min="0" step="1000" required />
                <div class="invalid-feedback">Silahkan, masukkan jumlah yang sesuai</div>
              </div>

              <div class="mb-3">
                <label for="billDueDate" class="form-label">Jatuh Tempo *</label>
                <input type="date" class="form-control" id="billDueDate" required />
                <div class="invalid-feedback">Silahkan, masukkan tanggal jatuh tempo</div>
              </div>

              <div class="mb-3">
                <label for="billStatus" class="form-label">Status *</label>
                <select class="form-select" id="billStatus" required>
                  <option value="">Pilih status...</option>
                  <option value="paid">Dibayar</option>
                  <option value="unpaid">Terlambat</option>
                    <option value="draft">Draf</option>
                </select>
                <div class="invalid-feedback">Silahkan pilih status.</div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="button" class="btn btn-primary" id="saveBillBtn"><i class="fas fa-save me-2"></i>Simpan Tagihan</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
      class BillManager {
        constructor() {
          this.bills = [];
          this.currentFilter = "all";
          this.editingId = null;
          this.storageKey = "billPaymentReminder_bills";
          this.themeKey = "billPaymentReminder_theme";
          this.init();
        }

        init() {
          this.loadFromStorage();
          this.loadTheme();
          this.renderBills();
          this.updateDashboard();
          this.setupEventListeners();
          this.updateBillStatuses();

          // If no bills exist, load sample data
          if (this.bills.length === 0) {
            this.loadSampleData();
          }
        }

        // Sample data uses dates relative to today for demonstration purposes
        loadSampleData() {
          const today = new Date();
          const formatDate = (date) => date.toISOString().split("T")[0];
          this.bills = [
            {
              id: 1,
              title: "Wi-Fi Indihome",
              amount: 150000,
              dueDate: formatDate(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000)), // 7 days from today
              status: "paid",
              createdDate: formatDate(new Date(today.getTime() - 23 * 24 * 60 * 60 * 1000)), // 23 days ago
            },
            {
              id: 2,
              title: "Wi-Fi Indihome",
              amount: 150000,
              dueDate: formatDate(new Date(today.getTime() + 12 * 24 * 60 * 60 * 1000)), // 12 days from today
              status: "draft",
              createdDate: formatDate(new Date(today.getTime() - 18 * 24 * 60 * 60 * 1000)), // 18 days ago
            },
            {
              id: 3,
              title: "Wi-Fi Indihome",
              amount: 150000,
              dueDate: formatDate(new Date(today.getTime() - 5 * 24 * 60 * 60 * 1000)), // 5 days ago
              status: "overdue",
              createdDate: formatDate(new Date(today.getTime() - 25 * 24 * 60 * 60 * 1000)), // 25 days ago
            },
            {
              id: 4,
              title: "Wi-Fi Indihome",
              amount: 150000,
              dueDate: formatDate(new Date(today.getTime() + 20 * 24 * 60 * 60 * 1000)), // 20 days from today
              status: "unpaid",
              createdDate: formatDate(new Date(today.getTime() - 10 * 24 * 60 * 60 * 1000)), // 10 days ago
            },
          ];
          this.saveToStorage();
          this.renderBills();
          this.updateDashboard();
        }

        // LocalStorage Methods
        saveToStorage() {
          try {
            const billsData = {
              bills: this.bills,
              timestamp: new Date().toISOString(),
            };
            localStorage.setItem(this.storageKey, JSON.stringify(billsData));
            console.log("✅ Bills saved to localStorage");
          } catch (error) {
            console.error("❌ Error saving to localStorage:", error);
            // Fallback: continue with in-memory storage
          }
        }

        loadFromStorage() {
          try {
            const stored = localStorage.getItem(this.storageKey);
            if (stored) {
              const data = JSON.parse(stored);
              this.bills = data.bills || [];
              console.log(`✅ Loaded ${this.bills.length} bills from localStorage`);
            }
          } catch (error) {
            console.error("❌ Error loading from localStorage:", error);
            this.bills = [];
          }
        }

        // Theme Methods
        loadTheme() {
          try {
            const savedTheme = localStorage.getItem(this.themeKey) || "light";
            this.setTheme(savedTheme);
          } catch (error) {
            console.error("❌ Error loading theme:", error);
            this.setTheme("light");
          }
        }

        setTheme(theme) {
          document.documentElement.setAttribute("data-theme", theme);
          const themeIcon = document.getElementById("themeIcon");
          if (themeIcon) {
            themeIcon.className = theme === "dark" ? "fas fa-sun" : "fas fa-moon";
          }

          try {
            localStorage.setItem(this.themeKey, theme);
          } catch (error) {
            console.error("❌ Error saving theme:", error);
          }
        }

        toggleTheme() {
          const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
          const newTheme = currentTheme === "light" ? "dark" : "light";
          this.setTheme(newTheme);
        }

        // Dashboard Methods
        updateDashboard() {
          const stats = this.calculateStats();

          document.getElementById("totalBills").textContent = stats.total;
          document.getElementById("paidBills").textContent = stats.paid;
          document.getElementById("unpaidBills").textContent = stats.unpaid;
          document.getElementById("overdueBills").textContent = stats.overdue;
          document.getElementById("totalPaid").textContent = `Rp ${this.formatAmount(stats.totalPaidAmount)}`;
          document.getElementById("totalPending").textContent = `Rp ${this.formatAmount(stats.totalPendingAmount)}`;
        }

        calculateStats() {
          const stats = {
            total: this.bills.length,
            paid: 0,
            unpaid: 0,
            overdue: 0,
            draft: 0,
            totalPaidAmount: 0,
            totalPendingAmount: 0,
          };

          this.bills.forEach((bill) => {
            stats[bill.status]++;

            if (bill.status === "paid") {
              stats.totalPaidAmount += bill.amount;
            } else if (bill.status === "unpaid" || bill.status === "overdue") {
              stats.totalPendingAmount += bill.amount;
            }
          });

          return stats;
        }

        setupEventListeners() {
          // Theme toggle
          document.getElementById("themeToggle").addEventListener("click", () => {
            this.toggleTheme();
          });

          // Filter buttons
          document.querySelectorAll(".filter-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              this.setActiveFilter(e.target.dataset.status);
            });
          });

          // Search input
          document.getElementById("searchInput").addEventListener("input", (e) => {
            this.renderBills(e.target.value);
          });

          // Save bill button
          document.getElementById("saveBillBtn").addEventListener("click", () => {
            this.saveBill();
          });

          // Form validation
          document.getElementById("billForm").addEventListener("submit", (e) => {
            e.preventDefault();
            this.saveBill();
          });

          // Modal reset
          document.getElementById("billModal").addEventListener("hidden.bs.modal", () => {
            this.resetForm();
          });

          // Event delegation for edit and delete actions
          document.getElementById("billsTableBody").addEventListener("click", (e) => {
            const btn = e.target.closest("button[data-action]");
            if (!btn) return;
            const id = parseInt(btn.getAttribute("data-id"));
            if (btn.getAttribute("data-action") === "edit") {
              this.editBill(id);
            } else if (btn.getAttribute("data-action") === "delete") {
              this.deleteBill(id);
            }
          });
        }

        setActiveFilter(status) {
          // Update active button
          document.querySelectorAll(".filter-btn").forEach((btn) => {
            btn.classList.remove("active");
          });
          document.querySelector(`[data-status="${status}"]`).classList.add("active");

          this.currentFilter = status;
          this.renderBills();
        }

        updateBillStatuses() {
          const today = new Date().toISOString().split("T")[0];

          this.bills.forEach((bill) => {
            if (bill.status === "unpaid" && bill.dueDate < today) {
              bill.status = "overdue";
            }
          });
          this.saveToStorage();
        }
        getFilteredBills(searchTerm = "") {
          let filtered = [...this.bills];

          // Apply status filter
          if (this.currentFilter !== "all") {
            filtered = filtered.filter((bill) => bill.status === this.currentFilter);
          }

          // Apply search filter
          if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter((bill) => bill.title.toLowerCase().includes(term) || bill.amount.toString().includes(term));
          }

          return filtered;
        }

        renderBills(searchTerm = "") {
          const filtered = this.getFilteredBills(searchTerm);
          const tbody = document.getElementById("billsTableBody");
          const emptyState = document.getElementById("emptyState");
          const table = document.getElementById("billsTable");

          if (filtered.length === 0) {
            emptyState.classList.remove("d-none");
            table.classList.add("d-none");
          } else {
            emptyState.classList.add("d-none");
            table.classList.remove("d-none");

            tbody.innerHTML = filtered
              .map(
                (bill) => `
                        <tr>
                            <td><strong>${bill.title}</strong></td>
                            <td>${this.formatDate(bill.createdDate)}</td>
                            <td>${this.formatDate(bill.dueDate)}</td>
                            <td><strong>Rp. ${this.formatAmount(bill.amount)}</strong></td>
                            <td>
                                <span class="status-badge status-${bill.status}">
                                    ${this.getStatusDisplay(bill.status)}
                                </span>
                            </td>
                            <td>
                                <button class="action-btn edit-btn" data-action="edit" data-id="${bill.id}" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-btn" data-action="delete" data-id="${bill.id}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `
              )
              .join("");
          }
        }

        formatDate(dateString) {
          const date = new Date(dateString);
          return date.toLocaleDateString("id-ID", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
          });
        }

        formatAmount(amount) {
          return new Intl.NumberFormat("id-ID").format(amount);
        }

        getStatusDisplay(status) {
          const statusMap = {
            paid: "Paid",
            unpaid: "Unpaid",
            overdue: "Overdue",
            draft: "Draft",
          };
          return statusMap[status] || status;
        }

        editBill(id) {
          const bill = this.bills.find((b) => b.id === id);
          if (!bill) return;

          this.editingId = id;
          document.getElementById("modalTitle").textContent = "Edit Bill";
          document.getElementById("billTitle").value = bill.title;
          document.getElementById("billAmount").value = bill.amount;
          document.getElementById("billDueDate").value = bill.dueDate;
          document.getElementById("billStatus").value = bill.status;

          const modal = new bootstrap.Modal(document.getElementById("billModal"));
          modal.show();
        }

        deleteBill(id) {
          if (confirm("Are you sure you want to delete this bill?")) {
            this.bills = this.bills.filter((b) => b.id !== id);
            this.saveToStorage();
            this.renderBills();
            this.updateDashboard();
          }
        }

        saveBill() {
          const form = document.getElementById("billForm");

          if (!form.checkValidity()) {
            form.classList.add("was-validated");
            return;
          }

          const title = document.getElementById("billTitle").value.trim();
          const amount = parseInt(document.getElementById("billAmount").value);
          const dueDate = document.getElementById("billDueDate").value;
          const status = document.getElementById("billStatus").value;

          if (!title || !amount || !dueDate || !status) {
            form.classList.add("was-validated");
            return;
          }

          const billData = {
            title,
            amount,
            dueDate,
            status,
            createdDate: new Date().toISOString().split("T")[0],
          };

          if (this.editingId) {
            // Update existing bill
            const index = this.bills.findIndex((b) => b.id === this.editingId);
            if (index !== -1) {
              this.bills[index] = { ...this.bills[index], ...billData };
            }
          } else {
            // Create new bill
            const newId = self.crypto && self.crypto.randomUUID ? self.crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
            this.bills.push({ id: newId, ...billData });
          }
          this.saveToStorage();
          this.renderBills();
          this.updateDashboard();
          this.resetForm();

          const modal = bootstrap.Modal.getInstance(document.getElementById("billModal"));
          if (modal) {
            modal.hide();
          }
        }
        resetForm() {
          document.getElementById("billForm").reset();
          document.getElementById("billForm").classList.remove("was-validated");
          document.getElementById("modalTitle").textContent = "Create New Bill";
          this.editingId = null;
        }
      }

      // Initialize the app
      const billManager = new BillManager();

      // Auto-update overdue status every minute
      setInterval(() => {
        billManager.updateBillStatuses();
        billManager.renderBills();
        billManager.updateDashboard();
      }, 60000);
    </script>
  </body>
</html>
